<!DOCTYPE html>
<html>
<head>
  <title>Propex - Property Exporessions</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=yes"/>
  <script>
    if(location.protocol!=="file:"){
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-56551457-1', 'auto');
      ga('send', 'pageview');
    }
  </script>
  <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro:400,700' rel='stylesheet' type='text/css'>
  <style>
    .clearfix:before,.clearfix:after { content: " "; display: table; }
    .clearfix:after { clear: both; }

    /*h1,h2{font-family: 'Source Sans Pro', sans-serif; font-weight: 700;}*/
    #input,body,textarea{font-size:14px;font-family: 'Source Code Pro', sans-serif;}
    header{text-align:center; margin-bottom:30px;}
    header>h1{margin:0;font-size:3.5em;}
    article {width:960px;margin:0 auto 30px;}
    #input {border: solid 1px #000;  background-color: #fdfdfd}
    article>h2 {text-align: center;}
    #input,#target,#output,#handlers,#code{font-family: 'Source Code Pro', Courier, "Courier New", sans-serif}
    #input{display:block; width:940px; padding:10px; margin-bottom:30px;}
    #target,#output,#handlers,#code{min-height:400px;}

    #target,#handlers,article>h2:nth-of-type(odd){width:446px; float:left; margin:0}
    #target,#handlers {border:1px outset; padding:2px; background-color: #fdfdfd}

    #output,#code,article>h2:nth-of-type(even){width:448px; float:left; margin:0}
    #output,#code {padding:2px 30px;}
  </style>
</head>
<body>
<header role="banner">
  <h1>propex</h1>
  <small style="margin-top:-2px;  letter-spacing:-.5px; display: block;">{property,expressions[4{the,win}]}</small>
</header>
<article class="clearfix">
  <input id="input" value="{cat?,dog,things[$index{_id>id,name}]1?}">
  <h2>your data</h2>
  <h2>the output</h2>
  <textarea id="target">
{
  "cat": "RU",
  "things": [
    {
      "_id": "4e7e98",
      "name": "William"
    },
    {
      "_id": "d8cc60",
      "name": "Tom"
    },
    {
      "_id": "03f5c2",
      "name": "Mike"
    },
    {
      "_id": "f1d2c9",
      "name": "Gareth"
    }
  ]
}
  </textarea>
  <pre id="output"></pre>
<hr class="clearfix" style="float:left;width:100%;margin-top:20px;">
  <h2>handlers</h2>
  <h2>nodejs code</h2>
  <textarea id="handlers">return {
  index: function(prop,name,value,obj){
    obj[name] = value; //already transformed
    obj[name].index = name;
  },
  name: function(prop,name,value,obj){
    obj[name] = value.name;
  }
};</textarea>
  <pre id="code"></pre>

</article>
<footer style="text-align:center;">&copy; 2014 William Kapke</footer>

<script src="bundle.js"></script>
<script>
  var current_data;
  var current_propex;
  var current_handlers;
  function getData() {
    current_data = target.value;
    try{ return JSON.parse(target.value); }
    catch(e){}
  }

  function grr(n,value){
    return value===undefined? "\0":value;
  }
  function getHandlers(){
    current_handlers = handlers.value;
    try{ return Function(current_handlers)(); }
    catch(e){ }
  }

  var _Px = require('propex');
  function Px() {
    current_propex = input.value;
    try{ return _Px(current_propex); }
    catch(e){ return e; }
  }
  function update(){
    if(current_propex === input.value && current_data === target.value && current_handlers === handlers.value) return;
    var px = Px();
    if(px instanceof Error)
      return output.innerHTML = px+"\nCharacter:'"+px.character+"'" +"\nIndex: "+px.position;
    var data = getData();
    if(!data) return;
    var hndlrs = getHandlers();
    code.innerHTML = [
      'var Px = require("propex");',
      'var px = Px("'+px+'");',
      "function getHandlers(){\n  "+ (hndlrs? current_handlers.replace(/\n/g,'\n  ') : '')+"\n}",
      "var data = " + JSON.stringify(data,null,2)+";",
      "var output = px.copy(data, getHandlers());",
      "console.log(output);"
    ].join('\n');
    output.innerHTML = JSON.stringify(px.copy(data, hndlrs),grr,2).replace(/"\\u0000"/g,'undefined')
  }
  input.addEventListener("keyup", update);
  target.addEventListener("keyup", update);
  handlers.addEventListener("keyup", update);
  update();
</script>
</body>
</html>